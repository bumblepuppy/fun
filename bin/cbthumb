#!/usr/bin/perl

# vim: filetype=perl5
#
# needs unrar-nonfree
# needs unzip
# needs imagemagic "convert" utility
# needs gs (ghostscript)
#

use feature qw(say);
use warnings;
use strict;
use autodie;
use File::Basename qw(basename);
use URI::Encode;
use FindBin;
use lib "$FindBin::Bin/../lib/perl";
use Text::Wrapper;
use File::Spec;


sub make_thumbnail_from_first_page { 
    my ($archive_file, $first_page) = @_;
    my $thumbnail_name = "$archive_file.jpg";
    if (system("convert", $first_page, "-resize", "x615", $thumbnail_name)) {
       make_default_thumbnail($archive_file);
       return;
    }
    unlink($first_page);
}

my $wrapper = Text::Wrapper->new(columns => 34);

sub make_default_thumbnail {
    my $archive_file = shift;
    my $label = $wrapper->wrap($archive_file);
    system ("convert",
            "-background", "lightblue",
            "-fill", "blue",
            "-font", "FreeSans",
            "-pointsize","24",
            "-gravity", "center",
            "-size", "400x615",
            "caption:$archive_file",
            "$archive_file.jpg"
        );
}

opendir (my $dir_handle,".") || die "can't opendir '.' ";
my @cbr_files = grep { /\.cbr$/i && -f } readdir($dir_handle);
rewinddir($dir_handle);
my @cbz_files = grep { /\.cbz$/i && -f } readdir($dir_handle);
rewinddir($dir_handle);
my @pdf_files = grep { /\.pdf$/i && -f } readdir($dir_handle);

for (@cbr_files) {
    my $rar_file = $_;
    next if -f "$rar_file.jpg";
    my $quoted_rar_file = quotemeta($rar_file);
    my $first_page;
    my $lines;
    if (! open($lines, "unrar -t $quoted_rar_file |" )) {
        make_default_thumbnail($rar_file);
        next;
    }
    my @jpgs;
    while (<$lines>) {
 	chomp;
	next unless /\.(jpg|gif|png)$/i;
	next unless /\d\d/;
	push @jpgs, $_;
    }
    @jpgs = sort @jpgs;
    $first_page = $jpgs[0];
    $first_page =~ s/^\s+//;
    if ( system("unrar", $rar_file, $first_page) ) {
        make_default_thumbnail($rar_file);
        next;
    }
    make_thumbnail_from_first_page($rar_file,$first_page);
}

for (@cbz_files) {
    my $zip_file = $_;
    next if -f "$zip_file.jpg";
    my $quoted_zip_file = quotemeta($zip_file);
    my $first_page;
    my $lines;
    if (! open($lines, "unzip -l $quoted_zip_file |")) {
       make_default_thumbnail($zip_file);
        next;
    }
    my @jpgs;
    while (<$lines>) {
	my $path;
	chomp;
	next unless /\.(jpg|gif|png)$/i;
	next unless /\s+\d+\s+\d{4}\-\d\d\-\d\d\s+\d\d\:\d\d\s+(\S+.*)$/;
	$path = $1;
	push @jpgs, $path;
    }
    @jpgs = sort @jpgs;
    $first_page = $jpgs[0];
    $first_page =~ s/^\s+//;
    if (system("unzip","-u", $zip_file, $first_page)) {
        make_default_thumbnail($zip_file);
        next;
    }
    make_thumbnail_from_first_page($zip_file,$first_page);
}

for (@pdf_files) {
    next if -f "$_.jpg";
    if ( system("gs",
	   "-dBATCH",
	   "-dNOPAUSE",
	   "-dSAFER",
	   "-dFirstPage=1",
	   "-dLastPage=1",
	   "-sDEVICE=jpeg",
	   "-dJPEGQ=30",
	   "-r400x615",
	   "-sOutputFile=$_.jpg",
	   $_
         )) {
        make_default_thumbnail($_);
        next;
    }
}

opendir ($dir_handle,".") || die "can't opendir '.' ";
@cbr_files = grep { /\.cbr$/i && -f } readdir($dir_handle);
rewinddir($dir_handle);
@cbz_files = grep { /\.cbz$/i && -f } readdir($dir_handle);
rewinddir($dir_handle);
@pdf_files = grep { /\.pdf$/i && -f } readdir($dir_handle);


open my $index_file, ">", "index.html";

select $index_file;
say "<html>";
say "<head>";
say "     <title>comic index</title>";
say "     <style>";
say "         .directory {";
say "           display: grid;";
say "           grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));";
say "           grid-gap: 32px;";
say "           grid-auto-flow: dense;";
say "         }";
say "         ";
say "         /* Single column display for phones */";
say "        \@media (max-width: 459px) {";
say "           .directory {";
say "             display: flex;";
say "             flex-direction: column;";
say "           }";
say "         }";
say "    </style>";
say "</head>";
say "<body>";
say "    <div class=\"directory\">";

my @all_files = sort ( @cbr_files, @cbz_files, @pdf_files) ;
for (@all_files) {
    Encode::_utf8_on($_); #risky but it fixed some broken links
    my $archive = URI::Encode::uri_encode($_, { encode_reserved => 1 } );
    say "        <article class=\"article\">";
    say "            <a href=\"$archive\"><img src=\"$archive.jpg\" height=\"615\" width=\"400\"></a>";
    say "        </article>";
}

say "    </div>";
say "</body>";
say "</html>";
close $index_file;    
    
