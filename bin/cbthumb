#!/usr/bin/perl

# vim: filetype=perl5
#
# needs unrar
# needs unzip
# needs imagemagic "convert" utility
# needs gs (ghostscript)
#

use feature qw(say);
use warnings;
use strict;
use autodie;
use File::Basename qw(basename);
use URI::Encode;


sub make_thumbnail_from_first_page { 
    my ($archive_file, $first_page) = @_;
    my $thumbnail_name = "$archive_file.jpg";
    system("convert", $first_page, "-resize", "400x615", $thumbnail_name);
    unlink($first_page);
}

opendir (my $dir_handle,".") || die "can't opendir '.' ";
my @cbr_files = grep { /\.cbr$/i && -f } readdir($dir_handle);
rewinddir($dir_handle);
my @cbz_files = grep { /\.cbz$/i && -f } readdir($dir_handle);
rewinddir($dir_handle);
my @pdf_files = grep { /\.pdf$/i && -f } readdir($dir_handle);

for (@cbr_files) {
    my $rar_file = $_;
    my $quoted_rar_file = quotemeta($rar_file);
    my $first_page;
    open(my $lines, "unrar -t $quoted_rar_file |") || die "can't open quoted rar file: $!";
    my @jpgs;
    while (<$lines>) {
 	chomp;
	next unless /\.jpg$/i;
	next unless /\d\d\d/;
	push @jpgs, $_;
    }
    @jpgs = sort @jpgs;
    $first_page = $jpgs[0];
    $first_page =~ s/^\s+//;
    system("unrar", $rar_file, $first_page);
    make_thumbnail_from_first_page($rar_file,$first_page);
    say "rarfile:",$rar_file;
}

for (@cbz_files) {
    my $zip_file = $_;
    my $quoted_zip_file = quotemeta($zip_file);
    say "zip_file:",$zip_file;
    say "quoted:",$quoted_zip_file;
    my $first_page;
    open(my $lines, "unzip -l $quoted_zip_file |") || die "can't open quoted zip file: $!";
    my @jpgs;
    while (<$lines>) {
	my $path;
	chomp;
	next unless /\.jpg$/i;
	next unless /\s+\d+\s+\d{4}\-\d\d\-\d\d\s+\d\d\:\d\d\s+(\S+.*)$/;
	$path = $1;
	push @jpgs, $path;
    }
    @jpgs = sort @jpgs;
    $first_page = $jpgs[0];
    $first_page =~ s/^\s+//;
    say "first page:",$first_page;
    system("unzip","-u", $zip_file, $first_page);
    make_thumbnail_from_first_page($zip_file,$first_page);
}

for (@pdf_files) {
    system("gs",
	   "-dBATCH",
	   "-dNOPAUSE",
	   "-dSAFER",
	   "-dFirstPage=1",
	   "-dLastPage=1",
	   "-sDEVICE=jpeg",
	   "-dJPEGQ=30",
	   "-r400x615",
	   "-sOutputFile=$_.jpg",
	   $_
	);
}

opendir ($dir_handle,".") || die "can't opendir '.' ";
@cbr_files = grep { /\.cbr$/i && -f } readdir($dir_handle);
rewinddir($dir_handle);
@cbz_files = grep { /\.cbz$/i && -f } readdir($dir_handle);
rewinddir($dir_handle);
@pdf_files = grep { /\.pdf$/i && -f } readdir($dir_handle);


open my $index_file, ">", "index.html";

select $index_file;
say "<html>";
say "<head>";
say "     <title>comic index</title>";
say "     <style>";
say "         .directory {";
say "           display: grid;";
say "           grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));";
say "           grid-gap: 32px;";
say "           grid-auto-flow: dense;";
say "         }";
say "         ";
say "         /* Single column display for phones */";
say "        \@media (max-width: 459px) {";
say "           .directory {";
say "             display: flex;";
say "             flex-direction: column;";
say "           }";
say "         }";
say "    </style>";
say "</head>";
say "<body>";
say "    <div class=\"directory\">";

for (@cbr_files, @cbz_files, @pdf_files) {
    my $archive = URI::Encode::uri_encode($_);
    say "        <article class=\"article\">";
    say "            <a href=\"$archive\"><img src=\"$archive.jpg\" height=\"600\" width=\"415\"></a>";
    say "        </article>";
}

say "    </div>";
say "</body>";
say "</html>";
close $index_file;    
    
